name: Deploy Appwrite Function

on:
  workflow_call:
    inputs:
      function_id:
        description: Appwrite function ID to deploy
        required: true
        type: string
      entrypoint:
        description: Path to the function entrypoint file
        required: true
        type: string
      function_name:
        description: Human-readable function name (for logs)
        required: true
        type: string
      function_dir:
        description: Path to the function folder e.g. functions/createShare
        required: true
        type: string
    secrets:
      APPWRITE_ENDPOINT:
        required: true
      APPWRITE_PROJECT_ID:
        required: true
      APPWRITE_API_KEY:
        required: true

jobs:
  deploy:
    name: Deploy ${{ inputs.function_name }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: npm
          cache-dependency-path: ${{ inputs.function_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ inputs.function_dir }}
        run: npm ci

      - name: Install Appwrite CLI
        run: npm install -g appwrite-cli

      - name: Create deployment zip
        working-directory: ${{ inputs.function_dir }}
        run: |
          zip -r function.zip . \
            --exclude "*.git*" \
            --exclude ".env*" \
            --exclude "*.zip"

      - name: Deploy function
        working-directory: ${{ inputs.function_dir }}
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          appwrite client \
            --endpoint "$APPWRITE_ENDPOINT" \
            --project-id "$APPWRITE_PROJECT_ID" \
            --key "$APPWRITE_API_KEY"

          appwrite functions create-deployment \
            --function-id="${{ inputs.function_id }}" \
            --entrypoint="${{ inputs.entrypoint }}" \
            --code="function.zip" \
            --activate=true

      - name: Summarize
        if: success()
        run: |
          echo "### âœ… ${{ inputs.function_name }} deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Function ID:** \`${{ inputs.function_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Entrypoint:** \`${{ inputs.entrypoint }}\`" >> $GITHUB_STEP_SUMMARY