name: Deploy Appwrite Function

on:
  workflow_call:
    inputs:
      function_id:
        description: Appwrite function ID to deploy
        required: true
        type: string
      entrypoint:
        description: Path to the function entrypoint file (relative to function_dir)
        required: true
        type: string
      function_name:
        description: Human-readable function name (for logs)
        required: true
        type: string
      function_dir:
        description: Path to the function folder e.g. functions/createShare
        required: true
        type: string
    secrets:
      APPWRITE_ENDPOINT:
        required: true
      APPWRITE_PROJECT_ID:
        required: true
      APPWRITE_API_KEY:
        required: true

jobs:
  deploy:
    name: Deploy ${{ inputs.function_name }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: npm
          cache-dependency-path: ${{ inputs.function_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ inputs.function_dir }}
        run: npm ci

      - name: Create deployment zip
        working-directory: ${{ inputs.function_dir }}
        run: |
          zip -r ../../function.zip . \
            --exclude "*.git*" \
            --exclude ".env*" \
            --exclude "*.zip"

      - name: Upload deployment to Appwrite
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
          FUNCTION_ID: ${{ inputs.function_id }}
          ENTRYPOINT: ${{ inputs.entrypoint }}
        run: |
          # Use -s (silent) only — remove -f so we always get the response body on errors
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" --request POST \
            "$APPWRITE_ENDPOINT/v1/functions/$FUNCTION_ID/deployments" \
            --header "x-appwrite-project: $APPWRITE_PROJECT_ID" \
            --header "x-appwrite-key: $APPWRITE_API_KEY" \
            --form "entrypoint=$ENTRYPOINT" \
            --form "code=@function.zip" \
            --form "activate=true")

          # Split body and status code (last line is the status)
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n 1)

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response: $HTTP_BODY"

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "❌ Appwrite returned $HTTP_STATUS"
            exit 1
          fi

          DEPLOYMENT_ID=$(echo "$HTTP_BODY" | jq -r '.$id')

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "❌ Could not parse deployment ID from response"
            exit 1
          fi

          echo "✅ Deployment created: $DEPLOYMENT_ID"
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV

      - name: Wait for deployment to become active
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
          FUNCTION_ID: ${{ inputs.function_id }}
        run: |
          echo "⏳ Waiting for deployment to activate..."
          for i in $(seq 1 12); do
            sleep 5

            POLL_RESPONSE=$(curl -s -w "\n%{http_code}" --request GET \
              "$APPWRITE_ENDPOINT/v1/functions/$FUNCTION_ID/deployments/$DEPLOYMENT_ID" \
              --header "x-appwrite-project: $APPWRITE_PROJECT_ID" \
              --header "x-appwrite-key: $APPWRITE_API_KEY")

            POLL_BODY=$(echo "$POLL_RESPONSE" | head -n -1)
            POLL_STATUS=$(echo "$POLL_RESPONSE" | tail -n 1)
            STATUS=$(echo "$POLL_BODY" | jq -r '.status')

            echo "  HTTP $POLL_STATUS — Deployment status: $STATUS"

            if [ "$STATUS" = "ready" ]; then
              echo "✅ Deployment is live!"
              exit 0
            fi

            if [ "$STATUS" = "failed" ]; then
              echo "❌ Deployment failed! Build log:"
              echo "$POLL_BODY" | jq -r '.buildLogs // "No build logs available"'
              exit 1
            fi
          done

          echo "⚠️ Timed out waiting for deployment to become active"
          exit 1

      - name: Summarize
        if: success()
        run: |
          echo "### ✅ ${{ inputs.function_name }} deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment ID:** \`${{ env.DEPLOYMENT_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Entrypoint:** \`${{ inputs.entrypoint }}\`" >> $GITHUB_STEP_SUMMARY