name: Deploy Appwrite Function

on:
  workflow_call:
    inputs:
      function_id:
        description: Appwrite function ID to deploy
        required: true
        type: string
      entrypoint:
        description: Path to the function entrypoint file
        required: true
        type: string
      function_name:
        description: Human-readable function name (for logs)
        required: true
        type: string
      function_dir:
        description: Path to the function folder e.g. functions/createShare
        required: true
        type: string
    secrets:
      APPWRITE_ENDPOINT:
        required: true
      APPWRITE_PROJECT_ID:
        required: true
      APPWRITE_API_KEY:
        required: true

jobs:
  deploy:
    name: Deploy ${{ inputs.function_name }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: ${{ inputs.function_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ inputs.function_dir }}
        run: npm ci

      - name: Install Appwrite CLI (stable)
        run: npm install -g appwrite-cli@latest
      # - name: Install official Appwrite CLI
      #   run: |
      #     curl -sL https://appwrite.io/cli/install.sh | bash
      #     appwrite --version

      # - name: Create deployment zip
      #   run: |
      #     cd ${{ inputs.function_dir }}
      #     zip -r function.zip . \
      #       --exclude "*.git*" \
      #       --exclude ".env*" \
      #       --exclude "*.zip"
      #     echo "✅ Zip created: $(ls -lh function.zip)"

      - name: Create tar.gz package
        run: |
          tar -czf function.tar.gz -C ${{ inputs.function_dir }} .
          ls -lh function.tar.gz

      - name: Check zip
        run: ls -lh ${{ inputs.function_dir }}

      - name: Deploy function via REST API
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          curl -X POST "$APPWRITE_ENDPOINT/functions/${{ inputs.function_id }}/deployments" \
            -H "X-Appwrite-Project: $APPWRITE_PROJECT_ID" \
            -H "X-Appwrite-Key: $APPWRITE_API_KEY" \
            -H "Content-Type: multipart/form-data" \
            -F "code=@function.tar.gz" \
            -F "entrypoint=${{ inputs.entrypoint }}" \
            -F "activate=true"

      - name: Deploy function
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          appwrite client \
            --endpoint "$APPWRITE_ENDPOINT" \
            --project-id "$APPWRITE_PROJECT_ID" \
            --key "$APPWRITE_API_KEY"

          cd ${{ inputs.function_dir }}

          pwd
          ls -lah

          appwrite functions create-deployment \
            --function-id=${{ inputs.function_id }} \
            --entrypoint=${{ inputs.entrypoint }} \
            --code=. \
            --activate=false \
            --verbose

      - name: Summarize
        if: success()
        run: |
          echo "### ✅ ${{ inputs.function_name }} deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Function ID:** \`${{ inputs.function_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Entrypoint:** \`${{ inputs.entrypoint }}\`" >> $GITHUB_STEP_SUMMARY
